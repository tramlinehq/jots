<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Bitter">
  <link rel="stylesheet" href="https://notes.tramline.app/style.css">
  <title>notes | tramline</title>
</head>

<body>
<header>
  <svg width="68pt" viewBox="0 0 128 128">
    <g fill-rule="evenodd" fill="#333">
      <path d="m18.59 101.25c-4.6836 0-4.6836 9.3711 0 9.3711 4.5352 0 4.5352-9.3711 0-9.3711zm0 7.1016c-1.6641 0-1.6641-4.9883 0-4.9883 1.6641 0 1.6641 4.9883 0 4.9883z"/>
      <path d="m118.93 22.062c0-12.844-24.785-13.449-34.004-7.707l-10.426 6.043-10.125-5.8945c-0.45312-0.30078-0.90625-0.15234-1.3594 0.30078l-4.2305 4.8359c-0.30078 0.30078-0.30078 0.75391-0.15234 1.207l3.0234 6.9531-7.1016 4.082-10.125-5.8945c-0.45312-0.30078-1.0586-0.15234-1.3594 0.30078l-4.2305 4.8359c-0.30078 0.30078-0.45312 0.75391-0.30078 1.0586l3.1719 7.1016-28.41 16.32c-2.7188 1.6641-4.3828 4.5352-4.3828 7.707 0 0.15234 0 43.223 0.15234 43.223 1.0586 11.938 22.367 12.242 31.434 8.0078 1.6641 6.3477 8.7656 1.5117 10.426-3.0234 4.082 3.4766 9.9727-3.625 9.6719-8.3125l33.852-19.645c1.8125 6.3477 8.918 1.207 10.426-3.0234 4.3828 3.7773 9.9727-4.082 9.6719-8.4609 2.7188-1.6641 4.3828-4.2305 4.3828-7.4062v-42.617zm-54.855-5.1367 8.3125 4.6836-4.082 2.2656-6.8008-3.9297 2.5703-3.0234zm6.5 8.3125 3.9297-2.2656 8.7656 4.9883 2.7188 6.1953zm16.172 11.938-2.8711 3.1719-19.043-11.031-0.30078-0.60547 3.7773-2.2656zm-24.934-14.508 4.3828 2.5703-2.5703 1.5117zm-17.68 5.7422 8.3125 4.6836-4.082 2.418-6.9531-4.082 2.7188-3.0234zm6.5 8.3125 3.9297-2.2656 8.6133 4.9883 2.7188 6.043zm16.172 11.789-2.8711 3.3242-19.191-11.031-0.30078-0.60547 3.9297-2.2656 18.438 10.578zm-24.934-14.355 4.3828 2.5703-2.7188 1.5117zm-27.352 23.426 28.109-16.172 0.30078 0.60547c0 0.30078 0.15234 0.45312 0.45312 0.45312l20.098 11.789c0.45312 0.15234 1.0586 0.15234 1.5117-0.30078l4.2305-4.8359c0.15234-0.30078 0.30078-0.75391 0.15234-1.207l-4.2305-9.6719c-0.15234-0.30078-0.30078-0.45313-0.45313-0.60547l-7.8594-4.5352 5.7422-3.3242c0.15234 0.45312 0.30078 1.0586 0.75391 1.3594l20.25 11.637c0.45312 0.30078 1.0586 0.15234 1.3594-0.30078l4.2305-4.8359c0.30078-0.30078 0.45312-0.75391 0.15234-1.0586l-4.2305-9.8242c0-0.30078-0.15234-0.45312-0.45312-0.60547l-7.8594-4.5352 9.2188-5.2891c7.8594-4.5352 30.828-5.4414 30.828 5.7422 0 2.2656-1.207 4.3828-3.3242 5.5898l-71.633 41.258c-7.8594 4.5352-30.676 5.4414-30.676-5.5898 0-2.418 1.207-4.5352 3.3242-5.7422zm28.562 13.297 71.48-41.258c0.90625-0.45312 1.6641-1.0586 2.2656-1.8125v3.3242c-0.30078 2.1172-1.5117 4.082-3.3242 5.1367l-71.633 41.258c-8.4609 4.8359-18.891 4.8359-27.352 0-3.625-2.1172-3.3242-4.9883-3.3242-8.4609 6.8008 7.707 23.273 6.6484 31.887 1.8125zm69.363-17.227-8.0078 4.5352v-14.207l8.0078-4.5352zm-21.609 12.391-18.133 10.426v-14.055l18.133-10.578zm-79.641 22.969v-11.336c1.5117 1.6641 4.082 2.8711 6.3477 3.7773v14.355c-2.8711-1.207-6.3477-3.1719-6.3477-6.8008zm8.4609-6.9531c7.4062 2.2656 16.773 1.5117 23.426-2.5703v14.055c-7.4062 4.3828-15.113 5.7422-23.426 3.0234zm25.539-3.9297 5.2891-3.0234v14.207l-5.2891 3.0234zm7.4062-4.2305 17.832-10.277v14.207l-17.832 10.277zm40.348-23.273 9.2188-5.2891v26.75l-9.2188 5.2891zm-81.453 57.125c-0.75391-2.2656-0.30078-10.578-0.30078-13.297 7.1016 7.8594 23.426 6.3477 31.887 1.6641v14.66c-4.9883 3.9297-28.258 7.4062-31.586-3.0234zm31.133 5.7422c2.1172-1.207 4.3828-2.418 6.5-3.7773-0.60547 3.625-6.043 8.3125-6.5 3.7773zm9.0664-5.1367 6.6484-3.9297c-0.60547 3.9297-6.1953 8.6133-6.6484 3.9297zm44.883-25.992 6.5-3.7773c-0.60547 4.2305-6.043 8.1602-6.5 3.7773zm9.0664-5.1367 6.6484-3.9297c-0.60547 4.2305-6.3477 8.7656-6.6484 3.9297zm11.184-13.148c0.15234 2.418-1.207 4.8359-3.3242 6.043l-68.309 39.293v-14.508l45.641-26.297v10.73c0 0.75391 0.90625 1.3594 1.6641 0.90625l11.336-6.6484c0.45312-0.15234 0.60547-0.45312 0.60547-0.90625v-11.938l10.125-5.8945c0.90625-0.45312 1.6641-1.0586 2.2656-1.8125v11.031zm0-16.32c-0.15234 1.8125-0.90625 3.3242-2.2656 4.5352v-14.055c0.90625-0.60547 1.5117-1.0586 2.2656-1.8125v11.336z"/>
    </g>
  </svg>

  <a class="logo" href="/">notes Â§ tramline</a>

  <nav>
    <button onClick="switchScheme(this)">ðŸŒ… | ðŸŒ•</button>
  </nav>
</header>

<div class="border-b mb-3"></div>

<main>
  

<div class="feed">
	
	<div class="update">
		<div class="update-t">
			2023-01-06 14:36
			<br/>
			<span>âž¡</span>
			<span>kitallis</span>
		</div>
		<div class="update-s"><p><img src="/images/txns-suck.png" alt="" /></p>
<p>What a clusterfuck.</p>
</div>
	</div>
	
	<div class="update">
		<div class="update-t">
			2023-01-06 14:25
			<br/>
			<span>âž¡</span>
			<span>kitallis</span>
		</div>
		<div class="update-s"><p>I decided to add stricter linting to the codebase. Since I like what standard offers, I simply extended it with rails specific lints, in the following way:</p>
<pre data-lang="yaml" style="background-color:#383838;color:#e6e1dc;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#e8bf6a;">require</span><span>:
</span><span>  - </span><span style="color:#a5c261;">standard
</span><span>  - </span><span style="color:#a5c261;">rubocop-rails
</span><span>  - </span><span style="color:#a5c261;">rubocop-rspec
</span><span>  - </span><span style="color:#a5c261;">rubocop-performance
</span><span>
</span><span style="color:#e8bf6a;">inherit_gem</span><span>:
</span><span>  </span><span style="color:#e8bf6a;">standard</span><span>: </span><span style="color:#a5c261;">config/ruby-3.0.yml
</span><span>
</span><span style="color:#e8bf6a;">AllCops</span><span>:
</span><span>  </span><span style="color:#e8bf6a;">TargetRubyVersion</span><span>: </span><span style="color:#a5c261;">3.1
</span><span>  </span><span style="color:#e8bf6a;">NewCops</span><span>: </span><span style="color:#a5c261;">enable
</span><span>  </span><span style="color:#e8bf6a;">Exclude</span><span>:
</span><span>    - </span><span style="color:#a5c261;">bin/**/*
</span><span>    - </span><span style="color:#a5c261;">public/**/*
</span><span>    - </span><span style="color:#a5c261;">vendor/**/*
</span><span>    - </span><span style="color:#a5c261;">db/schema.rb
</span><span>
</span><span style="color:#e8bf6a;">Rails</span><span>:
</span><span>  </span><span style="color:#e8bf6a;">Enabled</span><span>: </span><span style="color:#6e9cbe;">true
</span><span>
</span><span style="color:#e8bf6a;">RSpec</span><span>:
</span><span>  </span><span style="color:#e8bf6a;">Enabled</span><span>: </span><span style="color:#6e9cbe;">true
</span><span>
</span><span style="color:#e8bf6a;">RSpec/ExampleLength</span><span>:
</span><span>  </span><span style="color:#e8bf6a;">Enabled</span><span>: </span><span style="color:#6e9cbe;">false
</span><span>
</span><span style="color:#e8bf6a;">RSpec/MultipleExpectations</span><span>:
</span><span>  </span><span style="color:#e8bf6a;">Max</span><span>: </span><span style="color:#a5c261;">4
</span><span>
</span><span style="color:#e8bf6a;">Performance</span><span>:
</span><span>  </span><span style="color:#e8bf6a;">Enabled</span><span>: </span><span style="color:#6e9cbe;">true
</span></code></pre>
<p>This ensures standard is used for ruby things, and rails, rspec and some other performance related checks in addition to it via rubocop.</p>
<p>I came across this suggestion while fixing the 100 odd offenses it threw up,</p>
<pre style="background-color:#383838;color:#e6e1dc;"><code><span>RSpec/NamedSubject:
</span><span>  Name your test subject if you need to reference it explicitly.
</span></code></pre>
<p>The fix,</p>
<pre data-lang="ruby" style="background-color:#383838;color:#e6e1dc;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span>subject(</span><span style="color:#f6f080;">:run</span><span>) { create(</span><span style="color:#f6f080;">:releases_train_run</span><span>) }
</span></code></pre>
<p>But what even is this? Isn't this just a <code>let</code> really? You can't really use the <code>is_expected.to</code> shortcut either since it's now named. I cannot possibly make the claim that this reads better.</p>
<p>I think it's just one of those garbagey rspec maximalisms.</p>
</div>
	</div>
	
	<div class="update">
		<div class="update-t">
			2022-10-11 15:44
			<br/>
			<span>âž¡</span>
			<span>kitallis</span>
		</div>
		<div class="update-s"><p>Here's a spectrum of componentizing views I've been thinking about lately (in Rails):</p>
<ol>
<li>Extract logical helpers and partials</li>
</ol>
<p>They are often like stuffing away code inside a <code>Module</code> and calling it a refactor. But it is cheap and effective enough to start off with. You often run into &quot;too many allocations&quot; issues, with nested views and partials. They also don't abstract state very well. Arguments for their limitations have been made ad naseam - <a href="https://github.com/drapergem/draper">ex</a>.</p>
<pre data-lang="text" style="background-color:#383838;color:#e6e1dc;" class="language-text "><code class="language-text" data-lang="text"><span>Completed 200 OK in 86ms (Views: 83.6ms | ActiveRecord: 1.3ms | Allocations: 29347)
</span></code></pre>
<ol start="2">
<li>Presenter objects / ViewComponents</li>
</ol>
<p>Solid ideas here. Fair bit of upfront work required and you have to be meticulous about the granularity of your components. These claim to be very fast by precompiling templates at rails boot.</p>
<ol start="3">
<li>SPAs, building JSX components (or whatever else is out there now)</li>
</ol>
<p>I'm not convinced I'd need to do this. I think Stimulus / Hotwired is powerful enough for all our needs for the forseeable future (famous last words). I still remember the joy of ripping out all the react from a <a href="https://github.com/simpledotorg/simple-server">previous codebase</a> I worked on and rewrote them in a much simpler, basic markup and js.</p>
<p>#1 âž¡ #2 hopefuly in a few months time.</p>
<p><em>I hate talking about views and view-logic too much because it's low-hanging fruit. Hopefully there's a more interesting stuff in here than just &quot;how to make your views be like visual basic style lego bricks&quot; type stuff.</em></p>
</div>
	</div>
	
	<div class="update">
		<div class="update-t">
			2022-10-06 12:23
			<br/>
			<span>âž¡</span>
			<span>kitallis</span>
		</div>
		<div class="update-s"><p>When I originally kicked things off, I added a lot of big transactions around various api-call-surrounding-database-ops. This was knowingly a cheap hack to avoid bad state changes and delaying the inevitable: careful and tedious handling of errors and control-flow.</p>
<p>I'm now slowly refactoring things to unpack these big transactions and I realize many of them are actually unnecessary. I'm employing yet another cheap <code>Result</code> object to signify boundary-states,</p>
<pre data-lang="ruby" style="background-color:#383838;color:#e6e1dc;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span>Result </span><span style="color:#cc7833;">= </span><span style="font-style:italic;color:#6e9cbe;">Struct</span><span>.</span><span style="color:#86c20e;">new</span><span>(</span><span style="color:#f6f080;">:ok?</span><span>, </span><span style="color:#f6f080;">:error</span><span>, </span><span style="color:#f6f080;">:value</span><span>, </span><span style="color:#f6f080;">keyword_init: </span><span style="color:#ae81ff;">true</span><span>)
</span><span>
</span><span style="font-weight:bold;color:#86c20e;">def </span><span style="color:#f6aa11;">good_op
</span><span>  </span><span style="font-style:italic;color:#6e9cbe;">Result</span><span>.</span><span style="color:#86c20e;">new</span><span>(</span><span style="color:#f6f080;">ok?: </span><span style="color:#ae81ff;">true</span><span>, </span><span style="color:#f6f080;">value: </span><span style="color:#a5c261;">1</span><span>)
</span><span style="font-weight:bold;color:#86c20e;">end
</span><span>
</span><span style="font-weight:bold;color:#86c20e;">def </span><span style="color:#f6aa11;">bad_op
</span><span>  </span><span style="font-style:italic;color:#6e9cbe;">Result</span><span>.</span><span style="color:#86c20e;">new</span><span>(</span><span style="color:#f6f080;">ok?: </span><span style="color:#ae81ff;">false</span><span>, </span><span style="color:#f6f080;">error: </span><span style="color:#f92672;">&quot;</span><span style="color:#c1be91;">Did not work</span><span style="color:#f92672;">&quot;</span><span>)
</span><span style="font-weight:bold;color:#86c20e;">end
</span><span>
</span><span>operation.ok?
</span><span>operation.value
</span><span>operation.error
</span></code></pre>
<p>This is a little bit silly, because it requires <em>you</em> to ensure that <code>value</code> is only present alongside the <code>ok?</code> and the others are falsey in the <code>error</code> case. But it is very simple and quick to get a refactor busted out.</p>
<p>I have used <a href="https://github.com/github/github-ds#githubresult">Github::Result</a> in the past, but recently discovered <a href="https://dry-rb.org/gems/dry-monads/1.3">dry-rb</a> -- many of these look very sensible and immediately useful. Hopefully the next step!</p>
</div>
	</div>
	
	<div class="update">
		<div class="update-t">
			2022-10-05 00:19
			<br/>
			<span>âž¡</span>
			<span>kitallis</span>
		</div>
		<div class="update-s"><p>So is your darned help text rubymine,</p>
<p><img src="/images/rubymine.png" alt="" /></p>
</div>
	</div>
	
	<div class="update">
		<div class="update-t">
			2022-09-28 11:15
			<br/>
			<span>âž¡</span>
			<span>kitallis</span>
		</div>
		<div class="update-s"><p>There are a few tight, but rare-enough race-conditions lingering about and they are constantly bothering me. They just exist as <code>FIXMEs</code> in the code atm.</p>
<p>Most of the these seem to be solvable by pessimistic row-locks, but I'm already dreading the littering of necessary but unintuitive placements of various row-locks throughout the code-base.</p>
<p>Would modelling this as a pure declarative orchestrator help keep this in check?</p>
<p>Not sure.</p>
</div>
	</div>
	
	<div class="update">
		<div class="update-t">
			2022-09-28 11:15
			<br/>
			<span>âž¡</span>
			<span>kitallis</span>
		</div>
		<div class="update-s"><p>The views currently are a hot mess, giant nested ERB templates.
I'm not convinced of jumping into <a href="https://viewcomponent.org">ViewComponents</a> yet, since the shape of this UI is so nebulous and will definitely change dramatically and I do not want to deal with more objects and more abstractions and more code at the moment.</p>
<p>I'll deal with the complex markup like it's 1999.</p>
</div>
	</div>
	
	<div class="update">
		<div class="update-t">
			2022-09-28 09:02
			<br/>
			<span>âž¡</span>
			<span>kitallis</span>
		</div>
		<div class="update-s"><p>It's not terribly hard to come up with a state-machine DSL like <a href="https://github.com/aasm/aasm">aasm</a>
by hand, but the <code>ActiveRecord</code> support is very handy.</p>
<p>I'm using it with an <code>enum</code> against a <code>status</code> field with the following options:</p>
<pre data-lang="ruby" style="background-color:#383838;color:#e6e1dc;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span>{
</span><span>  </span><span style="color:#f6f080;">column: :status</span><span>,
</span><span>  </span><span style="color:#f6f080;">requires_lock: </span><span style="color:#ae81ff;">true</span><span>,
</span><span>  </span><span style="color:#f6f080;">requires_new_transaction: </span><span style="color:#ae81ff;">false</span><span>,
</span><span>  </span><span style="color:#f6f080;">enum: </span><span style="color:#ae81ff;">true</span><span>,
</span><span>  </span><span style="color:#f6f080;">create_scopes: </span><span style="color:#ae81ff;">false
</span><span>}
</span></code></pre>
<p>The <code>requires_new_transaction</code> is <code>false</code> to avoid landing into unnecessary nested transactions. I'll keep my transactions explicit and intentional.
The <code>enum</code> allows me to play well with the Rails enum which already generates scopes, so I keep <code>create_scopes</code> off.</p>
<p>The <code>requires_lock</code> is seemingly quite handy at first glance, since I require locking rows a fair bit because of the distributed nature of the app.
But the level at which it locks is far too granular. I generally seem to require locking rows for far longer and more work than simply transitioning state and not everything can be sanely encapsulated in a <code>before</code> or <code>after</code>.
I'd rather provide the library with methods that cause a state transition than the inverted way it currently operates: generating methods to transition for you and then locking within that event.</p>
</div>
	</div>
	
	<div class="update">
		<div class="update-t">
			2022-09-26 11:37
			<br/>
			<span>âž¡</span>
			<span>kitallis</span>
		</div>
		<div class="update-s"><p>I'm finding keeping POROs seperated away from <code>models/</code> a mental relief for some reason. I think I'm going to stick to it.</p>
<p><img src="/images/dir.png" alt="" /></p>
</div>
	</div>
	
	<div class="update">
		<div class="update-t">
			2022-09-25 21:18
			<br/>
			<span>âž¡</span>
			<span>kitallis</span>
		</div>
		<div class="update-s"><p>The log streams feature in <a href="https://render.com">Render</a> is a little bit strange. From the <a href="https://render.com/docs/log-streams#configuring-log-streams">docs</a>,</p>
<pre data-lang="txt" style="background-color:#383838;color:#e6e1dc;" class="language-txt "><code class="language-txt" data-lang="txt"><span>Render Log Streams forward logs from your web services, private services, background workers, databases, and cron jobs to any logging provider that supplies a TLS-enabled syslog drain.
</span></code></pre>
<p>I hooked this up with datadog and it is indeed a syslog drain across <em>all</em> services. This means my newly setup datadog is now filled with thousands of non-application related logs. Not only now do I have to filter all these out, but also pay for them.</p>
<p>Surely, a log streaming pipeline should have service-level or content-level filtering as a baseline feature?</p>
</div>
	</div>
	
</div>

<nav class="pageControls">
	
	
	
</nav>


</main>

<script type="text/javascript" src="https://notes.tramline.app/elasticlunr.min.js"></script>
<script type="text/javascript" src="https://notes.tramline.app/search_index.en.js"></script>
<script src="https://notes.tramline.app/main.js"></script>
<script type="text/javascript">
	updateScheme();
</script>
</body>
</html>
